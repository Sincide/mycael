#!/usr/bin/env bash
# Generate theme from wallpaper using Matugen and reload Mycael
set -Eeuo pipefail

usage() {
  echo "Usage: mycael-matugen-apply [WALLPAPER]" >&2
  exit 1
}

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  usage
fi

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/quickshell/mycael"
MATUGEN_CFG="${XDG_CONFIG_HOME:-$HOME/.config}/matugen/config.toml"
LOG_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/mycael/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/matugen.log"

log() { printf '%s\n' "$*" >>"$LOG_FILE"; }

get_wallpaper() {
  if [[ -n ${1:-} ]]; then printf '%s\n' "$1"; return; fi
  if command -v swww >/dev/null 2>&1; then
    swww query 2>/dev/null | grep -oP 'image: \K.*' | head -n1 && return
  fi
  if command -v hyprctl >/dev/null 2>&1; then
    hyprctl hyprpaper list 2>/dev/null | awk '{print $2}' | head -n1 && return
  fi
  if [[ -f "$CONFIG_DIR/config/wallpaper.conf" ]]; then
    head -n1 "$CONFIG_DIR/config/wallpaper.conf" && return
  fi
  return 1
}

wallpaper=$(get_wallpaper "$1") || { log "Could not determine wallpaper"; exit 1; }

log "Generating scheme for $wallpaper"

tmpdir=$(mktemp -d)
trap 'rm -rf "$tmpdir"' EXIT

if ! matugen image "$wallpaper" --config "$MATUGEN_CFG" --prefix "$tmpdir" >>"$LOG_FILE" 2>&1; then
  log "matugen failed"; exit 1; fi

install -Dm644 "$tmpdir/quickshell/mycael/colors/colors-generated.js" "$CONFIG_DIR/colors/colors-generated.js"
install -Dm644 "$tmpdir/quickshell/mycael/colors/qtcolors.conf" "$CONFIG_DIR/colors/qtcolors.conf"

if systemctl --user is-active --quiet mycael.service; then
  systemctl --user restart mycael.service >>"$LOG_FILE" 2>&1 || true
fi
